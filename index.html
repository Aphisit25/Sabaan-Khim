<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ชาบ้านน้องขิม</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Prompt", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Noto Sans", "Ubuntu", "Cantarell", "Helvetica Neue", "Arial", "sans-serif"],
          },
          colors: {
            brand: {
              50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a'
            },
            tea: {
              50: '#fefce8', 100: '#fef9c3', 200: '#fef08a', 300: '#fde047', 400: '#facc15', 500: '#eab308', 600: '#ca8a04', 700: '#a16207', 800: '#854d0e', 900: '#713f12'
            }
          },
          boxShadow: {
            'soft': '0 4px 20px rgba(0, 0, 0, 0.08)',
            'elevated': '0 8px 32px rgba(0, 0, 0, 0.1)',
            'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out',
            'slide-in': 'slideIn 0.3s ease-out',
            'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'slide-up': 'slideUp 0.3s ease-out',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideIn: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            pulse: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.5' } },
          }
        }
      }
    }
  </script>
  <!-- Prompt font for Thai typography -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f0fdfa 0%, #e5e7eb 100%);
      scroll-behavior: smooth;
      overscroll-behavior: none;
      font-size: 16px;
    }
    .glass {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 1rem;
    }
    .card-hover {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(90deg, #14b8a6, #0d9488);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, #0d9488, #14b8a6);
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: linear-gradient(90deg, #eab308, #ca8a04);
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      background: linear-gradient(90deg, #ca8a04, #eab308);
      transform: translateY(-2px);
    }
    .btn-disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      ring: 2px solid #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
    }
    .menu-card img {
      transition: transform 0.4s ease;
    }
    .menu-card:hover img {
      transform: scale(1.05);
    }
    .filter-chip {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      background-color: #f3f4f6;
      color: #374151;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .filter-chip:hover {
      background-color: #e5e7eb;
    }
    .filter-chip.selected {
      background-color: #14b8a6;
      color: white;
    }
    .recommended-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background-color: #eab308;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .preorder-note {
      color: #ca8a04;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .floating-search-btn {
      position: fixed;
      bottom: 4rem;
      right: 1rem;
      z-index: 50;
      background: linear-gradient(90deg, #14b8a6, #0d9488);
      padding: 0.75rem;
      border-radius: 9999px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, background 0.3s ease;
    }
    .floating-search-btn:hover {
      transform: scale(1.1);
      background: linear-gradient(90deg, #0d9488, #14b8a6);
    }
    .modal {
      animation: slide-up 0.3s ease-out;
      border-radius: 1rem 1rem 0 0;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    @media (min-width: 640px) {
      .modal {
        border-radius: 1rem;
        width: auto;
        max-width: 32rem;
      }
      #searchFilterModal {
        align-items: center;
      }
      .floating-search-btn {
        display: none;
      }
    }
    @media (max-width: 640px) {
      #cartBottomSheet {
        width: 100%;
        max-height: 85vh;
        transform: translateY(100%);
        transition: transform 0.4s ease-in-out;
      }
      #cartBottomSheet.open {
        transform: translateY(0);
      }
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.5rem;
    }
    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding: 2rem 1.5rem;
      margin-top: 2rem;
    }
    .footer a {
      color: #14b8a6;
      transition: color 0.3s ease;
    }
    .footer a:hover {
      color: #0d9488;
    }
    .footer svg {
      width: 1.5rem;
      height: 1.5rem;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body class="font-sans text-gray-900 min-h-screen">
  <script>
    const TELEGRAM_BOT_TOKEN = "7778167506:AAFB5V66g5NjwrSv6WvAUL2jDcV3ccUcxIk";
    const TELEGRAM_CHAT_ID = "-1002728257218";
    const TELEGRAM_PROXY_URL = "";
    const STORE_LOCATION = { lat: 13.7325997, lng: 100.9996336 };
  </script>
  <!-- Header -->
  <header class="sticky top-0 z-40 shadow-soft">
    <div class="glass backdrop-blur border-b border-gray-200/50">
      <div class="max-w-7xl mx-auto header-container">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-tea-500 flex items-center justify-center shadow-glow">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white">
              <path d="M3 3h14a1 1 0 011 1v5a5 5 0 005 5h-1a6 6 0 01-6 6H9a6 6 0 01-6-6V4a1 1 0 011-1zm15 6V5H5v7a4 4 0 004 4h6a4 4 0 004-4V9zm2 0a3 3 0 002-2.236V11a3 3 0 01-2-2z"/>
            </svg>
          </div>
          <div class="flex-1">
            <h1 class="text-xl md:text-2xl font-bold tracking-tight text-gray-900">ชาบ้านน้องขิม</h1>
            <p class="text-sm text-gray-500">สั่งง่าย ส่งไว อร่อยทุกแก้ว</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="openSearchModalBtn" class="hidden md:block p-3 rounded-full bg-gray-100 hover:bg-gray-200 transition">
            <svg class="w-6 h-6 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
          <button id="openCartBtn" class="relative p-3 rounded-full bg-brand-600 hover:bg-brand-500 transition shadow-glow">
            <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span id="cartCountBadge" class="absolute -top-1 -right-1 text-xs bg-tea-500 text-white rounded-full w-5 h-5 grid place-content-center shadow">0</span>
          </button>
          <button id="openHamburgerBtn" class="md:hidden p-3 rounded-full bg-gray-100 hover:bg-gray-200 transition">
            <svg class="w-6 h-6 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <div class="hidden md:flex items-center gap-3">
            <button id="themeToggleBtn" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 transition text-sm font-medium">สลับโหมด</button>
            <button id="loginBtn" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 transition text-sm font-medium">เข้าสู่ระบบ</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Floating Search Button (Mobile Only) -->
  <button id="openSearchModalBtnMobile" class="md:hidden floating-search-btn">
    <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
  </button>

  <!-- Hamburger Menu Drawer -->
  <div id="hamburgerMenu" class="fixed inset-y-0 right-0 w-3/4 max-w-sm bg-white/95 backdrop-blur border-l border-gray-200 translate-x-full transition-transform z-50 flex flex-col md:hidden">
    <div class="p-4 flex items-center justify-between border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">เมนู</h3>
      <button id="closeHamburgerBtn" class="text-gray-500 hover:text-gray-900">✕</button>
    </div>
    <div class="p-4 flex flex-col gap-3">
      <button id="hamburgerThemeToggleBtn" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 transition text-sm font-medium text-left">สลับโหมด</button>
      <button id="hamburgerLoginBtn" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 transition text-sm font-medium text-left">เข้าสู่ระบบ</button>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 space-y-6">
      <div id="adminControls" class="glass rounded-xl p-6 hidden shadow-soft">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <h2 class="text-lg font-semibold text-gray-900">จัดการเมนู</h2>
          <div class="flex items-center gap-3">
            <button id="addMenuBtn" class="px-4 py-2 rounded-full btn-primary text-white transition text-sm font-medium">+ เพิ่มเมนู</button>
            <button id="importJsonBtn" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 transition text-sm font-medium">นำเข้า JSON</button>
            <button id="exportJsonBtn" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 transition text-sm font-medium">ส่งออก JSON</button>
          </div>
        </div>
        <p class="text-sm text-gray-500 mt-2">จัดการเมนูของคุณได้อย่างง่ายดาย เก็บข้อมูลใน LocalStorage</p>
      </div>
      <div id="menuGrid" class="space-y-8"></div>
    </section>
    <aside class="lg:col-span-1 space-y-6 hidden lg:block">
      <div class="glass rounded-xl p-6 shadow-soft animate-fade-in">
        <h3 class="text-lg font-semibold text-gray-900">ตะกร้าของฉัน</h3>
        <div id="cartList" class="divide-y divide-gray-200 my-4"></div>
        <div class="space-y-2">
          <div class="flex items-center justify-between text-sm font-medium">
            <span>ยอดรวมสินค้า</span>
            <span id="cartSubTotal" class="font-bold text-gray-900">฿0.00</span>
          </div>
          <div class="flex items-center justify-between text-sm font-medium">
            <span>ค่าจัดส่ง</span>
            <span id="cartDeliveryFee" class="font-bold text-gray-900">฿0.00</span>
          </div>
          <div class="flex items-center justify-between text-sm font-medium">
            <span>รวมทั้งสิ้น</span>
            <span id="cartGrandTotal" class="font-bold text-gray-900">฿0.00</span>
          </div>
        </div>
        <div class="flex gap-3 mt-4">
          <button id="clearCartBtn" class="flex-1 px-4 py-3 rounded-full bg-red-600 hover:bg-red-500 text-white font-medium shadow-glow">ล้างตะกร้า</button>
          <button id="placeOrderBtn" class="flex-1 px-4 py-3 rounded-full btn-secondary text-white font-medium shadow-glow">สั่งออร์เดอร์</button>
        </div>
        <p id="deliveryNote" class="text-xs text-gray-500 mt-2"></p>
      </div>
    </aside>
    <button id="floatingOrderBtn" class="md:hidden fixed bottom-4 right-4 p-4 rounded-full btn-secondary text-white shadow-glow z-30">
      <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    </button>
  </main>

  <!-- Search and Filter Modal -->
  <div id="searchFilterModal" class="hidden fixed inset-0 z-50 bg-black/60 flex items-end p-0 md:p-4 md:place-items-center">
    <div class="w-full max-w-md glass rounded-xl p-6 md:p-8 modal max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">ค้นหาและกรอง</h3>
        <button id="closeSearchFilterModal" class="text-gray-500 hover:text-gray-900 text-2xl p-3">✕</button>
      </div>
      <div class="space-y-6">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input id="searchInput" placeholder="ค้นหาเมนู..." class="w-full pl-10 pr-3 py-3 bg-white/80 text-gray-900 rounded-xl focus:ring-2 focus:ring-brand-500 transition text-base" />
        </div>
        <div class="flex flex-col gap-4">
          <h3 class="text-sm font-medium text-gray-700">หมวดหมู่</h3>
          <div id="categoryChips" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="flex flex-col gap-4">
          <h3 class="text-sm font-medium text-gray-700">เรียงลำดับ</h3>
          <div id="sortChips" class="flex flex-wrap gap-2">
            <button data-sort="default" class="filter-chip selected">ปกติ</button>
            <button data-sort="price-asc" class="filter-chip">ราคา: น้อย → มาก</button>
            <button data-sort="price-desc" class="filter-chip">ราคา: มาก → น้อย</button>
            <button data-sort="name-asc" class="filter-chip">ชื่อ: A → Z</button>
            <button data-sort="name-desc" class="filter-chip">ชื่อ: Z → A</button>
          </div>
        </div>
        <div class="flex justify-end gap-3">
          <button id="clearFiltersBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-900 text-base font-medium">ล้าง</button>
          <button id="applyFiltersBtn" class="px-4 py-2 rounded-xl btn-primary text-white text-base font-medium shadow-glow">นำไปใช้</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="hidden fixed inset-0 z-50 bg-black/60 flex items-end p-0 md:p-4 md:place-items-center">
    <div class="w-full max-w-md glass rounded-xl p-6 md:p-8 modal max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">สั่งเครื่องดื่มหรือแซนด์วิช</h3>
        <button id="closeOrderModal" class="text-gray-500 hover:text-gray-900 text-2xl p-3">✕</button>
      </div>
      <form id="orderForm" class="grid gap-6">
        <div>
          <label class="text-base font-medium text-gray-700">เลือกเมนู</label>
          <select id="selectedMenu" required class="mt-2 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition text-base">
            <option value="">— เลือกเมนู —</option>
          </select>
          <p id="preorderNote" class="preorder-note hidden">*ต้องสั่งล่วงหน้า 1-2 วัน</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-base font-medium text-gray-700">ราคา / ชิ้น (฿)</label>
            <input id="price" type="number" min="0" step="0.5" required class="mt-2 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition text-base" placeholder="เช่น 35.00" />
          </div>
          <div>
            <label class="text-base font-medium text-gray-700">จำนวน</label>
            <div class="mt-2 flex items-center rounded-xl overflow-hidden bg-white/80">
              <button type="button" id="qtyMinus" class="quantity-control w-12 h-12 grid place-content-center hover:bg-gray-200 transition text-lg">−</button>
              <input id="qty" type="number" value="1" min="1" class="w-full text-center bg-transparent text-gray-900 text-base py-3" />
              <button type="button" id="qtyPlus" class="quantity-control w-12 h-12 grid place-content-center hover:bg-gray-200 transition text-lg">+</button>
            </div>
          </div>
        </div>
        <div id="sweetnessSection">
          <label class="text-base font-medium text-gray-700">ความหวาน (สำหรับเครื่องดื่ม)</label>
          <div class="mt-2 grid grid-cols-5 gap-2">
            <label class="bg-white/80 rounded-xl px-3 py-2 text-center text-base cursor-pointer hover:bg-gray-200 transition">
              <input type="radio" name="sweet" value="25%" class="sr-only" />
              <span>หวานน้อย</span>
            </label>
            <label class="bg-white/80 rounded-xl px-3 py-2 text-center text-base cursor-pointer hover:bg-gray-200 transition">
              <input type="radio" name="sweet" value="50%" class="sr-only" checked />
              <span>หวานปกติ</span>
            </label>
          </div>
        </div>
        <div>
          <label class="text-base font-medium text-gray-700">วิธีรับสินค้า</label>
          <div class="mt-2 grid grid-cols-2 gap-4">
            <label class="bg-white/80 rounded-xl px-4 py-3 flex items-center gap-2 cursor-pointer hover:bg-gray-200 transition">
              <input type="radio" name="fulfill" value="รับเองที่ร้าน" class="accent-brand-600 w-5 h-5" checked />
              <span class="text-base">รับเอง</span>
            </label>
            <label class="bg-white/80 rounded-xl px-4 py-3 flex items-center gap-2 cursor-pointer hover:bg-gray-200 transition">
              <input type="radio" name="fulfill" value="จัดส่ง" class="accent-brand-600 w-5 h-5" />
              <span class="text-base">จัดส่ง</span>
            </label>
          </div>
        </div>
        <div id="deliveryAddressSection" class="hidden">
          <label class="text-base font-medium text-gray-700">ที่อยู่จัดส่ง</label>
          <textarea id="deliveryAddress" rows="3" placeholder="กรุณากรอกที่อยู่สำหรับจัดส่ง" class="mt-2 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition text-base"></textarea>
          <!-- <button type="button" id="getLocationBtn" class="mt-2 px-4 py-2 rounded-xl btn-primary text-white text-base font-medium">ใช้ตำแหน่งปัจจุบัน</button> -->
          <p id="deliveryStatus" class="text-sm text-gray-500 mt-2"></p>
        </div>
        <div>
          <label class="text-base font-medium text-gray-700">โน้ตถึงร้าน</label>
          <textarea id="note" rows="3" placeholder="เช่น ชื่อผู้สั่ง, เบอร์โทร, แยกน้ำแข็ง, ใส่ฟองนม" class="mt-2 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition text-base"></textarea>
        </div>
        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
          <div class="text-base text-gray-500">ยอดรวม: <span id="total" class="font-semibold text-gray-900">฿0.00</span></div>
          <button id="addToCartBtn" type="button" class="px-4 py-2 rounded-xl btn-primary text-white text-base font-medium shadow-glow">เพิ่มลงตะกร้า</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Menu Modal -->
  <div id="menuModal" class="hidden fixed inset-0 z-50 bg-black/60 grid place-items-center p-4">
    <div class="w-full max-w-md glass rounded-xl p-6 modal">
      <div class="flex items-center justify-between">
        <h3 id="menuModalTitle" class="text-lg font-semibold text-gray-900">เพิ่มเมนู</h3>
        <button id="closeMenuModal" class="text-gray-500 hover:text-gray-900">✕</button>
      </div>
      <form id="menuForm" class="mt-4 grid gap-4">
        <input type="hidden" id="menuId" />
        <div>
          <label class="text-sm font-medium text-gray-700">ชื่อเมนู</label>
          <input id="menuName" required class="mt-1 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition" placeholder="เช่น ชานม, แซนด์วิชแฮมชีส" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">ราคา (฿)</label>
          <input id="menuPrice" type="number" step="0.5" min="0" required class="mt-1 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">หมวดหมู่</label>
          <input id="menuCategory" class="mt-1 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition" placeholder="เช่น ชา, แซนด์วิช" />
        </div>
        <div class="flex items-center gap-3">
          <input id="isRecommended" type="checkbox" class="accent-brand-600 w-5 h-5" />
          <label for="isRecommended" class="text-sm text-gray-700">เมนูแนะนำ</label>
        </div>
        <div class="flex items-center gap-3">
          <input id="requiresPreorder" type="checkbox" class="accent-brand-600 w-5 h-5" />
          <label for="requiresPreorder" class="text-sm text-gray-700">ต้องสั่งล่วงหน้า</label>
        </div>
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" id="deleteMenuBtn" class="hidden px-4 py-2 rounded-full bg-red-600 hover:bg-red-500 text-white font-medium">ลบ</button>
          <button type="submit" class="px-4 py-2 rounded-full btn-primary text-white font-medium">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 bg-black/60 grid place-items-center p-4">
    <div class="w-full max-w-sm glass rounded-xl p-6 modal">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">เข้าสู่ระบบ (ผู้ดูแล)</h3>
        <button id="closeLoginModal" class="text-gray-500 hover:text-gray-900">✕</button>
      </div>
      <form id="loginForm" class="mt-4 grid gap-4">
        <div>
          <label class="text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
          <input id="username" required class="mt-1 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition" placeholder="เช่น admin321" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
          <input id="password" type="password" required class="mt-1 w-full bg-white/80 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 transition" placeholder="รหัสผ่าน" />
        </div>
        <div class="flex items-center justify-end pt-2">
          <button type="submit" class="px-4 py-2 rounded-full btn-primary text-white font-medium">เข้าสู่ระบบ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cart Bottom Sheet (Mobile Only) -->
  <div id="cartBottomSheet" class="md:hidden fixed inset-x-0 bottom-0 w-full bg-white/95 backdrop-blur rounded-t-xl shadow-glow translate-y-full transition-transform z-50 flex flex-col">
    <div class="p-4 flex items-center justify-between border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">ตะกร้า</h3>
      <button id="closeCartBtn" class="text-gray-500 hover:text-gray-900">✕</button>
    </div>
    <div id="cartBottomSheetList" class="flex-1 overflow-y-auto p-4 divide-y divide-gray-200"></div>
    <div class="p-4 border-t border-gray-200 space-y-3">
      <div class="space-y-2">
        <div class="flex items-center justify-between text-sm font-medium">
          <span>ยอดรวมสินค้า</span>
          <span id="bottomSheetSubTotal" class="font-bold text-gray-900">฿0.00</span>
        </div>
        <div class="flex items-center justify-between text-sm font-medium">
          <span>ค่าจัดส่ง</span>
          <span id="bottomSheetDeliveryFee" class="font-bold text-gray-900">฿0.00</span>
        </div>
        <div class="flex items-center justify-between text-sm font-medium">
          <span>รวมทั้งสิ้น</span>
          <span id="bottomSheetTotal" class="font-bold text-gray-900">฿0.00</span>
        </div>
      </div>
      <div class="flex gap-3">
        <button id="bottomSheetClearCartBtn" class="flex-1 px-4 py-3 rounded-full bg-red-600 hover:bg-red-500 text-white font-medium shadow-glow">ล้างตะกร้า</button>
        <button id="bottomSheetPlaceOrderBtn" class="flex-1 px-4 py-3 rounded-full btn-secondary text-white font-medium shadow-glow">สั่งออร์เดอร์</button>
      </div>
      <p id="bottomSheetDeliveryNote" class="text-xs text-gray-500"></p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden"></div>

  <!-- Footer -->
  <footer class="footer">
    <div class="max-w-7xl mx-auto text-center">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">ติดต่อเรา</h3>
      <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8 text-base text-gray-700">
        <div class="flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="text-brand-600">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h18M9 3v2m6-2v2M3 19h18M5 7h14v12H5V7zm7 5a2 2 0 100 4 2 2 0 000-4z" />
          </svg>
          <span>โทร: <a href="tel:+66812345678">094-592-1521 (แตงโม)</a></span>
        </div>
        <div class="flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="text-brand-600">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3V2z" />
          </svg>
          <span><a href="https://www.facebook.com/chabannongkhim" target="_blank" rel="noopener noreferrer">Facebook: ชาบ้านน้องขิม</a></span>
        </div>
      </div>
      <p class="text-sm text-gray-500 mt-4">© 2025 ชาบ้านน้องขิม. สงวนลิขสิทธิ์.</p>
    </div>
  </footer>

  <script>
    // ---------- Utilities ----------
    const qs = (s, el = document) => el.querySelector(s);
    const qsa = (s, el = document) => [...el.querySelectorAll(s)];
    const money = n => `฿${(Number(n) || 0).toFixed(2)}`;
    const uid = () => Math.random().toString(36).slice(2, 9);

    function showToast(msg, type = "info") {
      const t = qs("#toast");
      t.className = `fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-3 rounded-full shadow-glow text-sm font-medium ${
        type === "error" ? "bg-red-600 text-white" : "bg-brand-600 text-white"
      }`;
      t.textContent = msg;
      t.classList.remove("hidden");
      setTimeout(() => t.classList.add("hidden"), 3000);
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    // Haversine formula to calculate distance in kilometers
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ---------- State ----------
    const store = {
      get menu() {
        return JSON.parse(localStorage.getItem("menuItems") || "[]");
      },
      set menu(v) {
        localStorage.setItem("menuItems", JSON.stringify(v));
      },
      get cart() {
        return JSON.parse(localStorage.getItem("cart") || "[]");
      },
      set cart(v) {
        localStorage.setItem("cart", JSON.stringify(Array.isArray(v) ? v : []));
      },
      get isAdmin() {
        return localStorage.getItem("isAdmin") === "true";
      },
      set isAdmin(v) {
        localStorage.setItem("isAdmin", v);
      },
      userLocation: null
    };

    // Admin credentials
    const ADMIN_USERNAME = "admin321";
    const ADMIN_PASSWORD = "Aphisit321";

    // Seed demo data
    function seedMenu() {
      if (store.menu.length) return;
      store.menu = [
        { id: uid(), name: "ชานมเย็น/ชาไทย", price: 25, category: "ชา", image: "", isRecommended: true, requiresPreorder: false },
        { id: uid(), name: "ชาเขียวเย็น", price: 25, category: "ชา", image: "", isRecommended: true, requiresPreorder: false },
        { id: uid(), name: "ชามะนาวเย็น", price: 25, category: "ชา", image: "", requiresPreorder: false },
        { id: uid(), name: "ชานมเผือกเย็น", price: 25, category: "ชา", image: "", requiresPreorder: false },
        { id: uid(), name: "เนสกาแฟเย็น", price: 25, category: "กาแฟ", image: "", isRecommended: false, requiresPreorder: false },
        { id: uid(), name: "โอเลี้ยง", price: 25, category: "กาแฟ", image: "", isRecommended: false, requiresPreorder: false },
        { id: uid(), name: "นมชมพู", price: 25, category: "นมสด/โกโก้", image: "", requiresPreorder: false },
        { id: uid(), name: "โกโก้เย็น", price: 25, category: "นมสด/โกโก้", image: "", requiresPreorder: false },
        { id: uid(), name: "นมสดเย็น", price: 25, category: "นมสด/โกโก้", image: "", isRecommended: false, requiresPreorder: false },
        { id: uid(), name: "เฉาก๊วยนมสด", price: 30, category: "นมสด/โกโก้", image: "", isRecommended: true, requiresPreorder: false },
        { id: uid(), name: "พั้นช์", price: 25, category: "น้ำผลไม้/เมนูสุขภาพ/โซดา", image: "", isRecommended: false, requiresPreorder: false },
        { id: uid(), name: "น้ำส้ม", price: 25, category: "น้ำผลไม้/เมนูสุขภาพ/โซดา", image: "", isRecommended: false, requiresPreorder: false },
        { id: uid(), name: "สตอเบอร์รี่นมสด", price: 25, category: "น้ำผลไม้/เมนูสุขภาพ/โซดา", image: "", isRecommended: true, requiresPreorder: false },
        { id: uid(), name: "แดงมะนาวโซดาเย็น", price: 25, category: "น้ำผลไม้/เมนูสุขภาพ/โซดา", image: "", isRecommended: false, requiresPreorder: false },
        { id: uid(), name: "บลูฮาวายโซดา", price: 25, category: "น้ำผลไม้/เมนูสุขภาพ/โซดา", image: "", requiresPreorder: false },
        { id: uid(), name: "น้ำผึ้งมะนาวโซดา", price: 25, category: "น้ำผลไม้/เมนูสุขภาพ/โซดา", image: "", requiresPreorder: false },
        { id: uid(), name: "แซนด์วิชไส้ทูน่า+ปูอัด", price: 25, category: "แซนด์วิช", image: "", isRecommended: false, requiresPreorder: true },
        { id: uid(), name: "แซนด์วิชไส้ไข่ดาว+ไส้กรอก", price: 25, category: "แซนด์วิช", image: "", isRecommended: false, requiresPreorder: true },
        { id: uid(), name: "แซนด์วิชไส้โบโลน่า+ปูอัด", price: 25, category: "แซนด์วิช", image: "", isRecommended: false, requiresPreorder: true },
        { id: uid(), name: "แซนด์วิชไส้แฮม+ไส้กรอก", price: 25, category: "แซนด์วิช", image: "", isRecommended: false, requiresPreorder: true },
        { id: uid(), name: "แซนด์วิชไส้หมูยอง", price: 25, category: "แซนด์วิช", image: "", isRecommended: false, requiresPreorder: true }
      ];
    }

    // ---------- Theme Toggle ----------
    function toggleTheme() {
      const body = document.body;
      const isLight = !body.classList.contains("dark-theme");
      body.classList.toggle("dark-theme", isLight);
      body.classList.toggle("light-theme", !isLight);
      qs("#themeToggleBtn").textContent = isLight ? "โหมดสว่าง" : "โหมดมืด";
      qs("#hamburgerThemeToggleBtn").textContent = isLight ? "โหมดสว่าง" : "โหมดมืด";
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    // ---------- Menu Rendering ----------
    function renderMenuOptions() {
      const sel = qs("#selectedMenu");
      sel.innerHTML = '<option value="">— เลือกเมนู —</option>' + store.menu.map(m => `<option data-price="${m.price}" data-preorder="${m.requiresPreorder}" value="${m.id}">${m.name}</option>`).join("");
    }

    let currentCategory = "";
    let currentSort = "default";

    function renderCategories() {
      const categories = [...new Set(store.menu.map(m => m.category || "อื่นๆ"))].sort();
      const container = qs("#categoryChips");
      container.innerHTML = '<button class="filter-chip selected" data-category="">ทั้งหมด</button>' + categories.map(c => `<button class="filter-chip" data-category="${c}">${c}</button>`).join("");
    }

    function getSorter(sort) {
      return (a, b) => {
        if (sort === "price-asc") return a.price - b.price;
        if (sort === "price-desc") return b.price - a.price;
        if (sort === "name-asc") return a.name.localeCompare(b.name, "th");
        if (sort === "name-desc") return b.name.localeCompare(a.name, "th");
        return 0;
      };
    }

    function renderMenuCard(m) {
      return `
        <div class="glass rounded-xl overflow-hidden card-hover shadow-soft menu-card relative">
          <div class="h-48 bg-gray-100 overflow-hidden">
            <img src="${m.image || 'https://placehold.net/400x400.png'}" alt="${m.name}" class="w-full h-full object-cover"/>
          </div>
          <div class="p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold text-gray-900">${m.name}</div>
                <div class="text-sm text-gray-500">${m.category || '-'}</div>
                <div class="text-sm font-medium text-gray-900 mt-1">${money(m.price)}</div>
                ${m.requiresPreorder ? '<div class="preorder-note">*ต้องสั่งล่วงหน้า 1-2 วัน</div>' : ''}
              </div>
              <div class="flex items-center gap-2">
                ${store.isAdmin ? `<button data-id="${m.id}" class="editMenu px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 text-sm font-medium">แก้ไข</button>` : ""}
                <button data-id="${m.id}" class="quickSelect px-3 py-1.5 rounded-full btn-primary text-white text-sm font-medium">เลือก</button>
              </div>
            </div>
          </div>
          ${m.isRecommended ? '<span class="recommended-badge">แนะนำ!</span>' : ""}
        </div>
      `;
    }

    function renderMenuGrid() {
      const search = qs("#searchInput").value.toLowerCase();
      let items = store.menu.filter(m => m.name.toLowerCase().includes(search));
      if (currentCategory) items = items.filter(m => (m.category || "อื่นๆ") === currentCategory);
      const sorter = getSorter(currentSort);
      if (currentSort !== "default") items.sort(sorter);

      const wrap = qs("#menuGrid");
      if (!items.length) {
        wrap.innerHTML = `<div class="text-center text-gray-500 py-6">ไม่มีเมนูที่ตรงกัน</div>`;
        return;
      }

      let html = "";
      const recommended = items.filter(m => m.isRecommended);
      if (recommended.length) {
        html += `
          <div>
            <h2 class="text-lg font-semibold text-gray-900 mb-4">เมนูแนะนำ</h2>
            <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6">
              ${recommended.map(renderMenuCard).join("")}
            </div>
          </div>
        `;
      }
      const groups = items.reduce((acc, m) => {
        const cat = m.category || "อื่นๆ";
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(m);
        return acc;
      }, {});
      const sortedCats = Object.keys(groups).sort();
      html += sortedCats.map(cat => `
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-4">${cat}</h2>
          <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6">
            ${groups[cat].map(renderMenuCard).join("")}
          </div>
        </div>
      `).join("");
      wrap.innerHTML = html;
    }

    // ---------- Cart ----------
    function cartSubTotal() {
      return store.cart.reduce((s, i) => s + (i.price || 0) * (i.qty || 0), 0);
    }

    function calculateDeliveryFee() {
      const subTotal = cartSubTotal();
      const hasDelivery = store.cart.some(item => item.fulfill.includes("จัดส่ง"));
      if (!hasDelivery || !store.userLocation) return 0;
      const distance = calculateDistance(STORE_LOCATION.lat, STORE_LOCATION.lng, store.userLocation.lat, store.userLocation.lng);
      if (subTotal >= 100) {
        return distance <= 10 ? 0 : null; // null indicates delivery not allowed
      } else {
        if (distance <= 3) return 0;
        if (distance <= 10) return 10;
        return null; // Delivery not allowed
      }
    }

    function canPlaceOrder() {
      const subTotal = cartSubTotal();
      const hasDelivery = store.cart.some(item => item.fulfill.includes("จัดส่ง"));
      if (!hasDelivery) return true;
      if (!store.userLocation) return false;
      const distance = calculateDistance(STORE_LOCATION.lat, STORE_LOCATION.lng, store.userLocation.lat, store.userLocation.lng);
      return distance <= 10;
    }

    function updateDeliveryStatus() {
      const subTotal = cartSubTotal();
      const hasDelivery = store.cart.some(item => item.fulfill.includes("จัดส่ง"));
      const deliveryFee = calculateDeliveryFee();
      const placeOrderBtn = qs("#placeOrderBtn");
      const bottomSheetPlaceOrderBtn = qs("#bottomSheetPlaceOrderBtn");
      const deliveryNote = qs("#deliveryNote");
      const bottomSheetDeliveryNote = qs("#bottomSheetDeliveryNote");

      if (!hasDelivery) {
        deliveryNote.textContent = "รับเองที่ร้าน: ไม่มีค่าจัดส่ง";
        bottomSheetDeliveryNote.textContent = "รับเองที่ร้าน: ไม่มีค่าจัดส่ง";
        placeOrderBtn.classList.remove("btn-disabled");
        bottomSheetPlaceOrderBtn.classList.remove("btn-disabled");
        placeOrderBtn.disabled = false;
        bottomSheetPlaceOrderBtn.disabled = false;
        return;
      }

      if (!store.userLocation) {
        deliveryNote.textContent = "กรุณาระบุตำแหน่งเพื่อคำนวณค่าจัดส่ง";
        bottomSheetDeliveryNote.textContent = "กรุณาระบุตำแหน่งเพื่อคำนวณค่าจัดส่ง";
        placeOrderBtn.classList.add("btn-disabled");
        bottomSheetPlaceOrderBtn.classList.add("btn-disabled");
        placeOrderBtn.disabled = true;
        bottomSheetPlaceOrderBtn.disabled = true;
        return;
      }

      const distance = calculateDistance(STORE_LOCATION.lat, STORE_LOCATION.lng, store.userLocation.lat, store.userLocation.lng);
      if (distance > 10) {
        deliveryNote.textContent = "ที่อยู่นี้อยู่นอกรัศมีการจัดส่ง (เกิน 10 กม.)";
        bottomSheetDeliveryNote.textContent = "ที่อยู่นี้อยู่นอกรัศมีการจัดส่ง (เกิน 10 กม.)";
        placeOrderBtn.classList.add("btn-disabled");
        bottomSheetPlaceOrderBtn.classList.add("btn-disabled");
        placeOrderBtn.disabled = true;
        bottomSheetPlaceOrderBtn.disabled = true;
      } else if (subTotal >= 100) {
        deliveryNote.textContent = `ระยะทาง ${distance.toFixed(1)} กม.: จัดส่งฟรี`;
        bottomSheetDeliveryNote.textContent = `ระยะทาง ${distance.toFixed(1)} กม.: จัดส่งฟรี`;
        placeOrderBtn.classList.remove("btn-disabled");
        bottomSheetPlaceOrderBtn.classList.remove("btn-disabled");
        placeOrderBtn.disabled = false;
        bottomSheetPlaceOrderBtn.disabled = false;
      } else if (distance <= 3) {
        deliveryNote.textContent = `ระยะทาง ${distance.toFixed(1)} กม.: จัดส่งฟรี`;
        bottomSheetDeliveryNote.textContent = `ระยะทาง ${distance.toFixed(1)} กม.: จัดส่งฟรี`;
        placeOrderBtn.classList.remove("btn-disabled");
        bottomSheetPlaceOrderBtn.classList.remove("btn-disabled");
        placeOrderBtn.disabled = false;
        bottomSheetPlaceOrderBtn.disabled = false;
      } else {
        deliveryNote.textContent = `ระยะทาง ${distance.toFixed(1)} กม.: ค่าจัดส่ง ฿10.00`;
        bottomSheetDeliveryNote.textContent = `ระยะทาง ${distance.toFixed(1)} กม.: ค่าจัดส่ง ฿10.00`;
        placeOrderBtn.classList.remove("btn-disabled");
        bottomSheetPlaceOrderBtn.classList.remove("btn-disabled");
        placeOrderBtn.disabled = false;
        bottomSheetPlaceOrderBtn.disabled = false;
      }
    }

    function renderCart() {
      const list = qs("#cartList");
      const bottomSheet = qs("#cartBottomSheetList");
      const badge = qs("#cartCountBadge");
      const subTotal = cartSubTotal();
      const deliveryFee = calculateDeliveryFee() || 0;
      const grandTotal = subTotal + deliveryFee;
      qs("#cartSubTotal").textContent = money(subTotal);
      qs("#cartDeliveryFee").textContent = money(deliveryFee);
      qs("#cartGrandTotal").textContent = money(grandTotal);
      qs("#bottomSheetSubTotal").textContent = money(subTotal);
      qs("#bottomSheetDeliveryFee").textContent = money(deliveryFee);
      qs("#bottomSheetTotal").textContent = money(grandTotal);
      badge.textContent = store.cart.reduce((s, i) => s + (i.qty || 0), 0);

      const itemHTML = (item, idx) => `
        <div class="py-4 flex items-start gap-4 hover:bg-gray-50/50 rounded-lg transition">
          <div class="flex-1">
            <div class="font-semibold text-gray-900">${item.name} <span class="text-xs text-gray-500">${item.sweet ? `(${item.sweet})` : ''}</span></div>
            <div class="text-sm font-medium text-gray-900">${money(item.price)}</div>
            <div class="text-xs text-gray-500 mt-1">${item.fulfill}${item.requiresPreorder ? ' • *ต้องสั่งล่วงหน้า 1-2 วัน' : ''}${item.note ? ` • โน้ต: ${item.note}` : ""}${item.address ? ` • ที่อยู่: ${item.address}` : ""}</div>
            <div class="mt-3 flex items-center gap-3">
              <button class="qtyDec px-3 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 font-medium" data-idx="${idx}">−</button>
              <span class="min-w-[2ch] text-center font-medium">${item.qty}</span>
              <button class="qtyInc px-3 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 font-medium" data-idx="${idx}">+</button>
              <button class="rmItem ml-auto px-3 py-2 rounded-full bg-red-600 hover:bg-red-500 text-white text-sm font-medium" data-idx="${idx}">ลบ</button>
            </div>
          </div>
        </div>`;

      const html = store.cart.map(itemHTML).join("") || '<div class="py-6 text-center text-gray-500">ยังไม่มีสินค้าในตะกร้า</div>';
      list.innerHTML = html;
      bottomSheet.innerHTML = html;
      updateDeliveryStatus();
    }

    // ---------- Form Interactions ----------
    function updatePriceFromSelect() {
      const sel = qs("#selectedMenu");
      const opt = sel.selectedOptions[0];
      if (opt && opt.dataset.price) {
        qs("#price").value = Number(opt.dataset.price).toFixed(2);
        const isPreorder = opt.dataset.preorder === "true";
        qs("#preorderNote").classList.toggle("hidden", !isPreorder);
        qs("#sweetnessSection").classList.toggle("hidden", isPreorder);
      }
      calcTotal();
    }

    function calcTotal() {
      const price = Number(qs("#price").value || 0);
      const qty = Math.max(1, Number(qs("#qty").value || 1));
      qs("#total").textContent = money(price * qty);
    }

    function addToCart() {
      const selId = qs("#selectedMenu").value;
      if (!selId) {
        showToast("กรุณาเลือกเมนู", "error");
        return;
      }
      const menu = store.menu.find(m => m.id === selId);
      const price = Number(qs("#price").value || 0);
      const qty = Math.max(1, Number(qs("#qty").value || 1));
      const sweet = menu.requiresPreorder ? "" : (qs('input[name="sweet"]:checked')?.value || "50%");
      const fulfill = qs('input[name="fulfill"]:checked')?.value || "รับเองที่ร้าน";
      const note = qs("#note").value.trim();
      const address = fulfill.includes("จัดส่ง") ? qs("#deliveryAddress").value.trim() : "";
      if (fulfill.includes("จัดส่ง") && !address) {
        showToast("กรุณากรอกที่อยู่จัดส่ง", "error");
        return;
      }
      if (fulfill.includes("จัดส่ง") && !store.userLocation) {
        showToast("กรุณาระบุตำแหน่งเพื่อคำนวณระยะทาง", "error");
        return;
      }
      if (menu.requiresPreorder) {
        showToast("เมนูนี้ต้องสั่งล่วงหน้า 1-2 วัน", "info");
      }

      const newItem = { id: uid(), menuId: selId, name: menu.name, price, qty, sweet, fulfill, note, address, requiresPreorder: menu.requiresPreorder };
      store.cart = [...store.cart, newItem];
      renderCart();
      closeOrderModal();
      showToast("เพิ่มลงตะกร้าแล้ว");
    }

    function clearCart() {
      store.cart = [];
      store.userLocation = null;
      renderCart();
      showToast("ล้างตะกร้าแล้ว");
    }

    // ---------- Telegram Integration ----------
    function buildOrderText() {
      const subTotal = cartSubTotal();
      const deliveryFee = calculateDeliveryFee() || 0;
      const grandTotal = subTotal + deliveryFee;
      const items = store.cart.map((item, idx) => {
        const lines = [
          `${idx + 1}. ${item.name} (${item.sweet || 'ไม่มีระดับความหวาน'})`,
          `   ราคา: ${money(item.price)} x ${item.qty} = ${money(item.price * item.qty)}`,
          `   วิธีรับ: ${item.fulfill}`,
          item.address ? `   ที่อยู่: ${item.address}` : "",
          item.note ? `   โน้ต: ${item.note}` : "",
          item.requiresPreorder ? `   *ต้องสั่งล่วงหน้า 1-2 วัน` : ""
        ];
        return lines.filter(l => l).join("\n");
      }).join("\n\n");

      const distance = store.userLocation ? calculateDistance(STORE_LOCATION.lat, STORE_LOCATION.lng, store.userLocation.lat, store.userLocation.lng).toFixed(1) : "N/A";
      return [
        "🧋 ออร์เดอร์ใหม่จากชาบ้านน้องขิม 🧋",
        "",
        items,
        "",
        `ยอดรวมสินค้า: ${money(subTotal)}`,
        `ค่าจัดส่ง${store.cart.some(i => i.fulfill.includes("จัดส่ง")) ? ` (ระยะทาง ${distance} กม.)` : ""}: ${money(deliveryFee)}`,
        `รวมทั้งสิ้น: ${money(grandTotal)}`
      ].join("\n");
    }

    async function sendOrderToTelegram(text) {
      const url = TELEGRAM_PROXY_URL || `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text,
            parse_mode: "Markdown"
          })
        });
        if (!response.ok) throw new Error("Failed to send order");
        return true;
      } catch (e) {
        showToast("ไม่สามารถส่งออร์เดอร์ไปยัง Telegram ได้", "error");
        console.error(e);
        return false;
      }
    }

    async function placeOrder() {
      if (!store.cart.length) {
        showToast("ตะกร้าว่าง", "error");
        return;
      }
      if (!canPlaceOrder()) {
        showToast("ไม่สามารถจัดส่งได้ เนื่องจากอยู่นอกรัศมี 10 กม.", "error");
        return;
      }
      const text = buildOrderText();
      const hasPreorder = store.cart.some(item => item.requiresPreorder);
      store.cart = [];
      store.userLocation = null;
      renderCart();
      closeCart();
      showToast(hasPreorder ? "สั่งออร์เดอร์สำเร็จ (แซนด์วิชต้องสั่งล่วงหน้า 1-2 วัน)" : "สั่งออร์เดอร์สำเร็จ");
      await sendOrderToTelegram(text);
    }

    // ---------- Menu Modal Logic ----------
    function openMenuModal(editId = null) {
      if (!store.isAdmin) {
        showToast("ต้องเป็นผู้ดูแลเพื่อจัดการเมนู", "error");
        return;
      }
      qs("#menuModal").classList.remove("hidden");
      qs("#menuForm").reset();
      qs("#menuId").value = "";
      qs("#deleteMenuBtn").classList.add("hidden");
      qs("#menuModalTitle").textContent = editId ? "แก้ไขเมนู" : "เพิ่มเมนู";
      if (editId) {
        const m = store.menu.find(x => x.id === editId);
        if (!m) return;
        qs("#menuId").value = m.id;
        qs("#menuName").value = m.name;
        qs("#menuPrice").value = m.price;
        qs("#menuCategory").value = m.category || "";
        qs("#isRecommended").checked = !!m.isRecommended;
        qs("#requiresPreorder").checked = !!m.requiresPreorder;
        qs("#deleteMenuBtn").classList.remove("hidden");
      }
    }

    function closeMenuModal() {
      qs("#menuModal").classList.add("hidden");
    }

    function upsertMenu(e) {
      e.preventDefault();
      if (!store.isAdmin) {
        showToast("ต้องเป็นผู้ดูแลเพื่อจัดการเมนู", "error");
        return;
      }
      const id = qs("#menuId").value || uid();
      const item = {
        id,
        name: qs("#menuName").value.trim(),
        price: Number(qs("#menuPrice").value || 0),
        category: qs("#menuCategory").value.trim(),
        image: "",
        isRecommended: qs("#isRecommended").checked,
        requiresPreorder: qs("#requiresPreorder").checked,
      };
      if (!item.name) {
        showToast("กรุณากรอกชื่อเมนู", "error");
        return;
      }
      let arr = store.menu.slice();
      const idx = arr.findIndex(x => x.id === id);
      if (idx > -1) arr[idx] = item;
      else arr.push(item);
      store.menu = arr;
      renderMenuGrid();
      renderMenuOptions();
      closeMenuModal();
      showToast("บันทึกเมนูแล้ว");
    }

    function deleteMenu() {
      if (!store.isAdmin) {
        showToast("ต้องเป็นผู้ดูแลเพื่อจัดการเมนู", "error");
        return;
      }
      const id = qs("#menuId").value;
      if (!id) return;
      store.menu = store.menu.filter(x => x.id !== id);
      renderMenuGrid();
      renderMenuOptions();
      closeMenuModal();
      showToast("ลบเมนูแล้ว");
    }

    // ---------- JSON Import/Export ----------
    function importJson() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const data = JSON.parse(ev.target.result);
            if (!Array.isArray(data)) throw new Error("Invalid JSON format");
            store.menu = data.map(item => ({
              ...item,
              id: item.id || uid(),
              price: Number(item.price) || 0,
              image: item.image || ""
            }));
            renderMenuGrid();
            renderMenuOptions();
            showToast("นำเข้าเมนูสำเร็จ");
          } catch (err) {
            showToast("ไม่สามารถนำเข้า JSON ได้", "error");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function exportJson() {
      const data = JSON.stringify(store.menu, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "menu.json";
      a.click();
      URL.revokeObjectURL(url);
      showToast("ส่งออกเมนูสำเร็จ");
    }

    // ---------- Login Logic ----------
    function openLoginModal() {
      qs("#loginModal").classList.remove("hidden");
      qs("#loginForm").reset();
    }

    function closeLoginModal() {
      qs("#loginModal").classList.add("hidden");
    }

    function handleLogin(e) {
      e.preventDefault();
      const username = qs("#username").value.trim();
      const password = qs("#password").value.trim();
      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        store.isAdmin = true;
        qs("#adminControls").classList.remove("hidden");
        qs("#loginBtn").textContent = "ออกจากระบบ";
        qs("#hamburgerLoginBtn").textContent = "ออกจากระบบ";
        qs("#loginBtn").onclick = handleLogout;
        qs("#hamburgerLoginBtn").onclick = handleLogout;
        renderMenuGrid();
        closeLoginModal();
        showToast("เข้าสู่ระบบสำเร็จ");
      } else {
        showToast("ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง", "error");
      }
    }

    function handleLogout() {
      store.isAdmin = false;
      qs("#adminControls").classList.add("hidden");
      qs("#loginBtn").textContent = "เข้าสู่ระบบ";
      qs("#hamburgerLoginBtn").textContent = "เข้าสู่ระบบ";
      qs("#loginBtn").onclick = openLoginModal;
      qs("#hamburgerLoginBtn").onclick = openLoginModal;
      renderMenuGrid();
      showToast("ออกจากระบบแล้ว");
    }

    // ---------- Cart Bottom Sheet ----------
    function openCart() {
      qs("#cartBottomSheet").classList.add("open");
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    function closeCart() {
      qs("#cartBottomSheet").classList.remove("open");
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    // ---------- Order Modal ----------
    function openOrderModal(menuId = null) {
      qs("#orderModal").classList.remove("hidden");
      qs("#orderForm").reset();
      qs("#selectedMenu").value = menuId || "";
      qs("#price").value = "";
      qs("#qty").value = "1";
      qs('input[name="sweet"][value="50%"]').checked = true;
      qs('input[name="fulfill"][value="รับเองที่ร้าน"]').checked = true;
      qs("#deliveryAddress").value = "";
      qs("#note").value = "";
      qs("#deliveryStatus").textContent = "";
      handleFulfillChange();
      updatePriceFromSelect();
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    function closeOrderModal() {
      qs("#orderModal").classList.add("hidden");
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    // ---------- Search and Filter Modal ----------
    function openSearchFilterModal() {
      renderCategories();
      qs("#searchFilterModal").classList.remove("hidden");
      qs("#searchInput").value = "";
      qsa("#categoryChips .filter-chip").forEach(chip => chip.classList.remove("selected"));
      qs("#categoryChips .filter-chip[data-category='']").classList.add("selected");
      qsa("#sortChips .filter-chip").forEach(chip => chip.classList.remove("selected"));
      qs("#sortChips .filter-chip[data-sort='default']").classList.add("selected");
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    function closeSearchFilterModal() {
      qs("#searchFilterModal").classList.add("hidden");
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    function applyFilters() {
      renderMenuGrid();
      closeSearchFilterModal();
      showToast("นำตัวกรองไปใช้แล้ว");
    }

    function clearFilters() {
      qs("#searchInput").value = "";
      currentCategory = "";
      currentSort = "default";
      qsa("#categoryChips .filter-chip").forEach(chip => chip.classList.remove("selected"));
      qs("#categoryChips .filter-chip[data-category='']").classList.add("selected");
      qsa("#sortChips .filter-chip").forEach(chip => chip.classList.remove("selected"));
      qs("#sortChips .filter-chip[data-sort='default']").classList.add("selected");
      renderMenuGrid();
      showToast("ล้างตัวกรองแล้ว");
    }

    // ---------- Delivery Address Handling ----------
    function handleFulfillChange() {
        const fulfill = qs('input[name="fulfill"]:checked')?.value || "รับเองที่ร้าน";
        const deliverySection = qs("#deliveryAddressSection");
        deliverySection.classList.toggle("hidden", !fulfill.includes("จัดส่ง"));
        if (!fulfill.includes("จัดส่ง")) {
            qs("#deliveryAddress").value = "";
            qs("#deliveryStatus").textContent = "";
            store.userLocation = null;
            renderCart();
        } else if (!store.userLocation) {
            // เรียกตำแหน่งอัตโนมัติเมื่อเลือก "จัดส่ง" และยังไม่มีตำแหน่ง
            getUserLocation();
        }
    }

    function getUserLocation() {
        if (!navigator.geolocation) {
            showToast("เบราว์เซอร์นี้ไม่รองรับการระบุตำแหน่ง", "error");
            qs("#deliveryStatus").textContent = "เบราว์เซอร์ไม่รองรับการระบุตำแหน่ง";
            return;
        }
        qs("#deliveryStatus").textContent = "กำลังดึงตำแหน่ง...";
        navigator.geolocation.getCurrentPosition(
            pos => {
            store.userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            const distance = calculateDistance(STORE_LOCATION.lat, STORE_LOCATION.lng, store.userLocation.lat, store.userLocation.lng);
            qs("#deliveryStatus").textContent = distance > 10 
                ? `ที่อยู่นี้อยู่นอกรัศมีการจัดส่ง (ระยะทาง ${distance.toFixed(1)} กม.)`
                : `ระยะทางจากร้าน ${distance.toFixed(1)} กม.`;
            renderCart();
            showToast("ดึงตำแหน่งสำเร็จ");
            },
            err => {
            showToast("ไม่สามารถดึงตำแหน่งได้: " + err.message, "error");
            store.userLocation = null;
            qs("#deliveryStatus").textContent = "ไม่สามารถดึงตำแหน่งได้ กรุณากรอกที่อยู่ด้วยตนเอง";
            renderCart();
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }

    // ---------- Event Listeners ----------
    function setupEventListeners() {
      // Theme Toggle
      qs("#themeToggleBtn").addEventListener("click", toggleTheme);
      qs("#hamburgerThemeToggleBtn").addEventListener("click", toggleTheme);

      // Hamburger Menu
      qs("#openHamburgerBtn").addEventListener("click", () => qs("#hamburgerMenu").classList.remove("translate-x-full"));
      qs("#closeHamburgerBtn").addEventListener("click", () => qs("#hamburgerMenu").classList.add("translate-x-full"));

      // Login
      qs("#loginBtn").addEventListener("click", store.isAdmin ? handleLogout : openLoginModal);
      qs("#hamburgerLoginBtn").addEventListener("click", store.isAdmin ? handleLogout : openLoginModal);
      qs("#loginForm").addEventListener("submit", handleLogin);
      qs("#closeLoginModal").addEventListener("click", closeLoginModal);

      // Cart
      qs("#openCartBtn").addEventListener("click", openCart);
      qs("#floatingOrderBtn").addEventListener("click", openCart);
      qs("#closeCartBtn").addEventListener("click", closeCart);
      qs("#clearCartBtn").addEventListener("click", clearCart);
      qs("#bottomSheetClearCartBtn").addEventListener("click", clearCart);
      qs("#placeOrderBtn").addEventListener("click", placeOrder);
      qs("#bottomSheetPlaceOrderBtn").addEventListener("click", placeOrder);

      // Cart Item Actions
      qs("#cartList").addEventListener("click", e => {
        const idx = Number(e.target.dataset.idx);
        if (e.target.classList.contains("qtyInc")) {
          store.cart[idx].qty = (store.cart[idx].qty || 1) + 1;
          store.cart = [...store.cart];
          renderCart();
        }
        if (e.target.classList.contains("qtyDec")) {
          if (store.cart[idx].qty > 1) {
            store.cart[idx].qty -= 1;
            store.cart = [...store.cart];
            renderCart();
          }
        }
        if (e.target.classList.contains("rmItem")) {
          store.cart = store.cart.filter((_, i) => i !== idx);
          renderCart();
          showToast("ลบรายการแล้ว");
        }
      });
      qs("#cartBottomSheetList").addEventListener("click", e => {
        const idx = Number(e.target.dataset.idx);
        if (e.target.classList.contains("qtyInc")) {
          store.cart[idx].qty = (store.cart[idx].qty || 1) + 1;
          store.cart = [...store.cart];
          renderCart();
        }
        if (e.target.classList.contains("qtyDec")) {
          if (store.cart[idx].qty > 1) {
            store.cart[idx].qty -= 1;
            store.cart = [...store.cart];
            renderCart();
          }
        }
        if (e.target.classList.contains("rmItem")) {
          store.cart = store.cart.filter((_, i) => i !== idx);
          renderCart();
          showToast("ลบรายการแล้ว");
        }
      });

      // Order Modal
      qs("#selectedMenu").addEventListener("change", updatePriceFromSelect);
      qs("#price").addEventListener("input", calcTotal);
      qs("#qty").addEventListener("input", calcTotal);
      qs("#qtyMinus").addEventListener("click", () => {
        const input = qs("#qty");
        input.value = Math.max(1, Number(input.value || 1) - 1);
        calcTotal();
      });
      qs("#qtyPlus").addEventListener("click", () => {
        const input = qs("#qty");
        input.value = Number(input.value || 1) + 1;
        calcTotal();
      });
      qs("#addToCartBtn").addEventListener("click", addToCart);
      qs("#closeOrderModal").addEventListener("click", closeOrderModal);
      qsa('input[name="fulfill"]').forEach(radio => radio.addEventListener("change", handleFulfillChange));
    //   qs("#getLocationBtn").addEventListener("click", getUserLocation);

      // Menu Grid Actions
      qs("#menuGrid").addEventListener("click", e => {
        const id = e.target.dataset.id;
        if (e.target.classList.contains("quickSelect")) openOrderModal(id);
        if (e.target.classList.contains("editMenu")) openMenuModal(id);
      });

      // Menu Modal
      qs("#addMenuBtn").addEventListener("click", () => openMenuModal());
      qs("#closeMenuModal").addEventListener("click", closeMenuModal);
      qs("#menuForm").addEventListener("submit", upsertMenu);
      qs("#deleteMenuBtn").addEventListener("click", deleteMenu);

      // Search and Filter Modal
      qs("#openSearchModalBtn").addEventListener("click", openSearchFilterModal);
      qs("#openSearchModalBtnMobile").addEventListener("click", openSearchFilterModal);
      qs("#closeSearchFilterModal").addEventListener("click", closeSearchFilterModal);
      qs("#applyFiltersBtn").addEventListener("click", applyFilters);
      qs("#clearFiltersBtn").addEventListener("click", clearFilters);
      qs("#searchInput").addEventListener("input", () => renderMenuGrid());
      qs("#categoryChips").addEventListener("click", e => {
        if (e.target.classList.contains("filter-chip")) {
          qsa("#categoryChips .filter-chip").forEach(chip => chip.classList.remove("selected"));
          e.target.classList.add("selected");
          currentCategory = e.target.dataset.category || "";
          renderMenuGrid();
        }
      });
      qs("#sortChips").addEventListener("click", e => {
        if (e.target.classList.contains("filter-chip")) {
          qsa("#sortChips .filter-chip").forEach(chip => chip.classList.remove("selected"));
          e.target.classList.add("selected");
          currentSort = e.target.dataset.sort || "default";
          renderMenuGrid();
        }
      });

      // JSON Import/Export
      qs("#importJsonBtn").addEventListener("click", importJson);
      qs("#exportJsonBtn").addEventListener("click", exportJson);
    }

    // ---------- Initialize ----------
    function init() {
      seedMenu();
      renderMenuGrid();
      renderMenuOptions();
      renderCart();
      qs("#adminControls").classList.toggle("hidden", !store.isAdmin);
      qs("#loginBtn").textContent = store.isAdmin ? "ออกจากระบบ" : "เข้าสู่ระบบ";
      qs("#hamburgerLoginBtn").textContent = store.isAdmin ? "ออกจากระบบ" : "เข้าสู่ระบบ";
      if (store.isAdmin) {
        qs("#loginBtn").onclick = handleLogout;
        qs("#hamburgerLoginBtn").onclick = handleLogout;
      }
      setupEventListeners();
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
